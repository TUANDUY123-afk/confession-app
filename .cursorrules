# Confession App - Cursor Rules & Project Documentation

## ğŸ“‹ Tá»•ng quan Project

ÄÃ¢y lÃ  má»™t á»©ng dá»¥ng **Confession App** (á»¨ng dá»¥ng tÃ¬nh yÃªu) vá»›i cÃ¡c tÃ­nh nÄƒng:
- Love Story: LÆ°u trá»¯ cÃ¢u chuyá»‡n tÃ¬nh yÃªu
- Photo Wall: TÆ°á»ng áº£nh chia sáº» khoáº£nh kháº¯c
- Shared Diary: Nháº­t kÃ½ chung cho cáº·p Ä‘Ã´i
- Gamification System: Há»‡ thá»‘ng game hÃ³a vá»›i hoa, Ä‘iá»ƒm, thÃ nh tÃ­ch
- Calendar & Events: Lá»‹ch vÃ  sá»± kiá»‡n Ä‘áº·c biá»‡t
- Notifications: Há»‡ thá»‘ng thÃ´ng bÃ¡o

## ğŸ› ï¸ Tech Stack

- **Framework**: Next.js 15.5.4 (App Router)
- **Language**: TypeScript 5 (strict mode)
- **Styling**: Tailwind CSS 4.1.9 + shadcn/ui components
- **Database**: Supabase (PostgreSQL)
- **Authentication**: Supabase Auth
- **Storage**: Supabase Storage
- **Animations**: Framer Motion
- **UI Components**: Radix UI primitives
- **Forms**: React Hook Form + Zod validation
- **Icons**: Lucide React

## ğŸ“ Cáº¥u trÃºc Project

```
app/
â”œâ”€â”€ api/              # API routes (Server-side)
â”œâ”€â”€ [pages]/          # Client pages
components/            # Reusable React components
lib/                   # Utilities, helpers, clients
scripts/               # SQL scripts, setup scripts
utils/                 # Utility functions
```

## ğŸ—„ï¸ Database Structure (Supabase)

### Tables chÃ­nh:
- `users`: ThÃ´ng tin ngÆ°á»i dÃ¹ng
- `love_story`: Dá»¯ liá»‡u cÃ¢u chuyá»‡n tÃ¬nh yÃªu (JSONB)
- `diary_entries`: Nháº­t kÃ½ chung
- `photos`: áº¢nh trong photo wall
- `comments`: BÃ¬nh luáº­n
- `likes`: LÆ°á»£t thÃ­ch
- `notifications`: ThÃ´ng bÃ¡o
- `love_points`: Äiá»ƒm tÃ¬nh yÃªu, streak, water, coins, owned_flowers
- `flower_points`: Äiá»ƒm nÆ°á»›c cho tá»«ng loÃ i hoa (má»—i hoa cÃ³ Ä‘iá»ƒm riÃªng)
- `achievements`: ThÃ nh tÃ­ch vÃ  progress
- `activity_log`: Nháº­t kÃ½ hoáº¡t Ä‘á»™ng

### Constants quan trá»ng:
- **COUPLE_ID**: `"default_couple"` - ID máº·c Ä‘á»‹nh cho cáº·p Ä‘Ã´i
- File: `lib/gamification-helpers.ts`, `app/api/gamification/**/route.ts`

### LÆ°u Ã½ Database:
- RLS (Row Level Security) Ä‘Ã£ Ä‘Æ°á»£c DISABLE cho táº¥t cáº£ tables
- Sá»­ dá»¥ng Service Role Key Ä‘á»ƒ bypass RLS
- Environment variables cáº§n: `NEXT_PUBLIC_SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`

## ğŸŒ¸ Gamification System (v4)

### Há»‡ thá»‘ng Hoa

**GiÃ¡ hoa hiá»‡n táº¡i:**
- Hoa Há»“ng (rose): 150 xu
- Hoa Tulip (tulip): 180 xu
- Hoa HÆ°á»›ng DÆ°Æ¡ng (sunflower): 220 xu
- Hoa NhÃ i (jasmine): 240 xu
- Hoa Oáº£i HÆ°Æ¡ng (lavender): 270 xu
- Hoa Anh ÄÃ o (cherry): 300 xu
- **Hoa má»›i (v4):**
  - Hoa Lan (orchid): 350 xu
  - Hoa Sen (lotus): 400 xu
  - Hoa Máº«u ÄÆ¡n (peony): 500 xu
  - Hoa Há»“ng VÃ ng (rose-gold): 600 xu
  - Hoa Há»“ng VÄ©nh Cá»­u (eternal-rose): 800 xu

**Há»‡ thá»‘ng Ä‘á»™ khÃ³ (theo giÃ¡):**
1. **Dá»…** (< 200 xu): 
   - Thresholds: [0, 300, 700, 1200]
   - Rewards: [40, 130, 300] xu

2. **KhÃ³** (200-299 xu):
   - Thresholds: [0, 500, 1000, 1500]
   - Rewards: [60, 180, 500] xu

3. **Ráº¥t KhÃ³** (300-399 xu):
   - Thresholds: [0, 600, 1200, 2000]
   - Rewards: [70, 220, 600] xu

4. **SiÃªu KhÃ³** (400-599 xu):
   - Thresholds: [0, 700, 1400, 2200]
   - Rewards: [80, 250, 650] xu

5. **Cá»±c KhÃ³** (â‰¥ 600 xu):
   - Thresholds: [0, 800, 1600, 2500]
   - Rewards: [100, 300, 800] xu

### Äiá»ƒm & Xu:
- **Water (nÆ°á»›c)**: DÃ¹ng Ä‘á»ƒ tÆ°á»›i hoa (10 nÆ°á»›c/láº§n tÆ°á»›i)
- **Coins (xu)**: DÃ¹ng Ä‘á»ƒ mua hoa, nháº­n tá»« thÆ°á»Ÿng giai Ä‘oáº¡n
- **Points**: Äiá»ƒm tá»•ng há»£p (lÆ°u trong `love_points.water`)
- **Flower Points**: Äiá»ƒm nÆ°á»›c cá»§a tá»«ng hoa riÃªng (lÆ°u trong `flower_points.points`)

### LÆ°u Ã½ quan trá»ng:
- Má»—i hoa cÃ³ Ä‘iá»ƒm riÃªng (trong `flower_points` table)
- `claimed_stages` lÃ  array chá»©a IDs dáº¡ng: `"${flowerId}_${stageIndex}"` (vÃ­ dá»¥: "rose_1", "orchid_2")
- Stage 3 (Ná»Ÿ Rá»™) threshold dÃ¹ng Ä‘á»ƒ unlock achievement `love_garden_bloom`
- Water bá»‹ trá»« khi tÆ°á»›i hoa, cáº§n kiá»ƒm tra race condition

## ğŸ’» Coding Conventions

### Components:
- LuÃ´n dÃ¹ng `"use client"` directive cho client components
- File naming: `kebab-case.tsx` cho components
- TypeScript: LuÃ´n type-safe, khÃ´ng dÃ¹ng `any` trá»« khi cáº§n thiáº¿t
- Import order: React â†’ Next.js â†’ Third-party â†’ Local components â†’ Utils â†’ Types

### API Routes:
- Äáº·t trong `app/api/[feature]/route.ts`
- LuÃ´n return `NextResponse.json()`
- Error handling: Return status code phÃ¹ há»£p (400, 500)
- Validation: Kiá»ƒm tra body params trÆ°á»›c khi xá»­ lÃ½

### State Management:
- Client components: `useState`, `useEffect`
- Server components: Fetch data trá»±c tiáº¿p
- KhÃ´ng dÃ¹ng global state management lib (Redux, Zustand) - project nhá» khÃ´ng cáº§n

### Styling:
- Tailwind CSS vá»›i utility classes
- Component UI dÃ¹ng shadcn/ui trong `components/ui/`
- Responsive: Mobile-first approach
- Dark mode: Há»— trá»£ qua `next-themes`

### Database:
- LuÃ´n dÃ¹ng `getSupabaseClient()` tá»« `lib/supabase-client.ts`
- Service role key Ä‘á»ƒ bypass RLS
- Error handling: Log vÃ  throw errors rÃµ rÃ ng

## ğŸš¨ Important Notes & Gotchas

### Race Conditions:
- **Water deduction**: LuÃ´n kiá»ƒm tra `currentWater >= water_to_add` trÆ°á»›c khi update
- **Flower watering**: Batch sync Ä‘á»ƒ trÃ¡nh nhiá»u requests cÃ¹ng lÃºc
- Xem: `components/my-flowers.tsx` - cÃ³ pending sync mechanism

### Version Management:
- Version Ä‘Æ°á»£c track trong `package.json` vÃ  `components/version-badge.tsx`
- Script update version: `npm run version:update`
- Changelog trong `version-badge.tsx` component
- Version hiá»ƒn thá»‹ trong gÃ³c mÃ n hÃ¬nh, khi click vÃ o sáº½ hiá»ƒn thá»‹ changelog modal vá»›i cÃ¡c thay Ä‘á»•i cá»§a version Ä‘Ã³ vÃ  cÃ¡c thay Ä‘á»•i cá»§a cÃ¡c version trÆ°á»›c Ä‘Ã³, cáº­p nháº­t version má»›i nháº¥t khi deploy lÃªn github vÃ­ dá»¥ v3 sáº½ lÃªn thÃ nh v4

### Image Handling:
- Upload qua `/api/upload-photo` vá»›i compression
- Images > 2MB Ä‘Æ°á»£c nÃ©n tá»± Ä‘á»™ng
- Sá»­ dá»¥ng `optimized-image.tsx` component

### Notifications:
- Context: `contexts/NotificationContext.tsx`
- Component: `components/FloatingNotification.tsx`
- API: `/api/notifications`

### JSX/React:
- **QUAN TRá»ŒNG**: Trong JSX text content, khÃ´ng dÃ¹ng `<` trá»±c tiáº¿p, pháº£i dÃ¹ng `&lt;` hoáº·c `{'>'}`
- Example: `Dá»… (&lt; 200 xu)` thay vÃ¬ `Dá»… (< 200 xu)`

## ğŸ“ File Locations Reference

- **Gamification helpers**: `lib/gamification-helpers.ts`
- **Flower shop component**: `components/flower-shop.tsx`
- **My flowers component**: `components/my-flowers.tsx`
- **Flower progress**: `components/flower-progress.tsx`
- **Gamification page**: `app/gamification/page.tsx`
- **V4 update log**: `components/v4-update-log.tsx`
- **Supabase client**: `lib/supabase-client.ts`
- **Supabase server**: `lib/supabase-server.ts` (náº¿u cÃ³)

## ğŸ”§ Development Commands

```bash
npm run dev        # Development server
npm run build      # Production build
npm run start      # Start production server
npm run lint       # Lint code
npm run version:update  # Update version
```

## ğŸ¯ Best Practices

1. **Error Handling**: LuÃ´n cÃ³ try-catch cho async operations
2. **Logging**: Console.log cho debug, xÃ³a khi commit
3. **Type Safety**: KhÃ´ng dÃ¹ng `any` trá»« khi tháº­t sá»± cáº§n
4. **Performance**: 
   - Lazy load components lá»›n
   - Optimize images
   - Debounce user inputs
5. **Accessibility**: DÃ¹ng semantic HTML, ARIA labels khi cáº§n
6. **Security**: KhÃ´ng commit API keys, env vars trong code 

## ğŸ“š Version History

- **v4**: Há»‡ thá»‘ng hoa má»›i, giÃ¡ tÄƒng, 5 loÃ i hoa má»›i, há»‡ thá»‘ng Ä‘á»™ khÃ³ 5 cáº¥p
- **v3**: Há»‡ thá»‘ng thÃ nh tÃ­ch nhiá»u giai Ä‘oáº¡n
- **v2**: NÃ©n áº£nh, tim bay effect, versioning system
- **v1**: Initial setup, image compression, upload system
- tá»± Ä‘á»™ng tÄƒng version khi cÃ³ báº¥t ká»³ thay Ä‘á»•i vÃ o gÃ³c mÃ n hÃ¬nh v4 update log vÃ­ dá»¥ v3 sáº½ lÃªn thÃ nh v4





---

*File nÃ y Ä‘Æ°á»£c táº¡o Ä‘á»ƒ AI assistant hiá»ƒu rÃµ project structure vÃ  conventions. Update khi cÃ³ thay Ä‘á»•i lá»›n.*
